# Learned Lessons

## 2025

- [2025-12-17] **配置生成安全**: 程序化生成 YAML/JSON 配置文件时，必须对动态内容中的特殊字符（尤其是引号）进行转义，防止语法破坏导致构建失败。
- [2025-12-17] **防御性数据处理**: 处理可选的数组数据（如 CMS 内容标签）时，始终提供默认值（如 `|| []`）以防止 `undefined` 导致的运行时或构建错误。
- [2025-12-17] **Library 音乐添加 SOP**: 用户指令为“添加音乐，[Link]”时执行以下流程：1. 抓取 URL 的 meta 信息（标题、歌手、OG 封面图）；2. 在 `src/content/library/` 创建文件；3. `spotifyUrl` 填入原始链接，`coverImage` 填入抓取到的封面图 URL，`comment` 填入一句话简介。组件会自动处理显示逻辑。
- [2025-12-17] **音乐封面图源规范**: 避免直接使用第三方 CDN (如 YouTube/Spotify) 链接作为 `coverImage`，因存在 404 或防盗链风险。必须将封面图**下载保存至本地** (`public/images/library-covers/`)，并在 content 文件中引用本地路径。
- [2025-12-17] **Content Schema 兼容性**: 在 `config.ts` 定义图片字段时，若需支持本地路径，不可仅使用 `z.string().url()`（会报错 `Invalid url`）。必须放宽为 `z.string()` 或使用 `z.union([image(), z.string()])` 以兼容本地相对/绝对路径。
- [2025-12-17] **File Naming Safety**: 严禁在文件或目录名中使用 URL 保留字符（如 `#`, `?`, `&`），这将导致 Vite/Rollup 模块解析失败（Error: `Rollup failed to resolve import`）。Content Collection 的文件命名应保持简洁，仅包含字母、数字、中文、连字符或下划线。
- [2025-12-18] **Astro View Transitions 脚本兼容性**: 使用 `ViewTransitions` 时，`DOMContentLoaded` 事件不会在软导航后触发。需使用 `astro:page-load`（每次新页面可见时）和 `astro:after-swap`（DOM 替换后立即执行）来确保脚本正确重新执行。主题初始化等防闪烁逻辑应放在 `<head>` 使用 `is:inline` 标记，并监听 `astro:after-swap` 以保持跨页状态。
- [2025-12-18] **View Transitions 事件监听器内存泄漏**: 在 `astro:page-load` 回调中直接添加事件监听器会导致每次导航都重复添加。解决方案：使用 `element.dataset.initialized` 标记防止重复绑定，或在添加新监听器前先移除旧监听器。

